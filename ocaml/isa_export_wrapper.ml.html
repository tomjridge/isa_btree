<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>isa_export_wrapper.ml</title>
<meta name="generator" content="emacs 26.1; htmlfontify 0.21" />
<style type="text/css"><!-- 
body { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.default   { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.default a { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.merlin-compilation-error-face-0003   { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.merlin-compilation-error-face-0003 a { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.merlin-compilation-error-face-0002   { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.merlin-compilation-error-face-0002 a { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.merlin-compilation-error-face-0001   { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.merlin-compilation-error-face-0001 a { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.merlin-compilation-error-face-0000   { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.merlin-compilation-error-face-0000 a { color: #ff0000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.tuareg-font-double-colon-face   { color: #ff4500;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.tuareg-font-double-colon-face a { color: #ff4500;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.string   { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.string a { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.builtin   { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.builtin a { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.constructor   { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.constructor a { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.keyword   { color: #a020f0;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.keyword a { color: #a020f0;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.variable-name   { color: #a0522d;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.variable-name a { color: #a0522d;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.function-name   { color: #0000ff;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.function-name a { color: #0000ff;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.comment   { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.comment a { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.comment-delimiter   { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.comment-delimiter a { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.label   { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.label a { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.type   { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.type a { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.operator   { color: #a52a2a;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.operator a { color: #a52a2a;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.module   { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.module a { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
span.governing   { color: #000000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: none; }
span.governing a { color: #000000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 10pt;  text-decoration: underline; }
 --></style>

    <script type="text/javascript"><!--
  // this function is needed to work around
  // a bug in IE related to element attributes
  function hasClass(obj)
  {
      var result = false;
      if (obj.getAttributeNode("class") != null)
      {
          result = obj.getAttributeNode("class").value;
      }
      return result;
  }

  function stripe(id)
  {
      // the flag we'll use to keep track of
      // whether the current row is odd or even
      var even = false;

      // if arguments are provided to specify the colors
      // of the even & odd rows, then use them;
      // otherwise use the following defaults:
      var evenColor = arguments[1] ? arguments[1] : "#fff";
      var oddColor  = arguments[2] ? arguments[2] : "#ddd";

      // obtain a reference to the desired table
      // if no such table exists, abort
      var table = document.getElementById(id);
      if (! table) { return; }

      // by definition, tables can have more than one tbody
      // element, so we'll have to get the list of child
      // &lt;tbody&gt;s
      var tbodies = table.getElementsByTagName("tbody");

      // and iterate through them...
      for (var h = 0; h < tbodies.length; h++)
      {
          // find all the &lt;tr&gt; elements...
          var trs = tbodies[h].getElementsByTagName("tr");

          // ... and iterate through them
          for (var i = 0; i < trs.length; i++)
          {
              // avoid rows that have a class attribute
              // or backgroundColor style
              if (! hasClass(trs[i]) &&
                  ! trs[i].style.backgroundColor)
              {
                  // get all the cells in this row...
                  var tds = trs[i].getElementsByTagName("td");

                  // and iterate through them...
                  for (var j = 0; j < tds.length; j++)
                  {
                      var mytd = tds[j];

                      // avoid cells that have a class attribute
                      // or backgroundColor style
                      if (! hasClass(mytd) &&
                          ! mytd.style.backgroundColor)
                      {
                          mytd.style.backgroundColor =
                            even ? evenColor : oddColor;
                      }
                  }
              }
              // flip from odd to even, or vice-versa
              even =  ! even;
          }
      }
  }

  function toggle_invis( name )
  {
      var filter =
        { acceptNode:
          function( node )
          { var classname = node.id;
            if( classname )
            { var classbase = classname.substr( 0, name.length );
              if( classbase == name ) { return NodeFilter.FILTER_ACCEPT; } }
            return NodeFilter.FILTER_SKIP; } };
      var walker = document.createTreeWalker( document.body           ,
                                              NodeFilter.SHOW_ELEMENT ,
                                              filter                  ,
                                              false                   );
      while( walker.nextNode() )
      {
          var e = walker.currentNode;
          if( e.style.display == "none" ) { e.style.display = "inline"; }
          else                            { e.style.display = "none";   }
      }
  }
--> </script>
  </head>
  <body onload="stripe('index'); return true;">

<pre><span class="governing">open </span><span class="module">Tjr_monad.Types</span>
<span class="governing">open </span><span class="module">Constants_type</span>
<span class="governing">open </span><span class="module">Isa_export</span>

<span class="governing">type</span> <span class="operator">(</span><span class="type">'node</span><span class="operator">,</span><span class="type">'leaf</span><span class="operator">)</span><span class="type"> dnode</span> <span class="operator">=</span> <span class="operator">(</span>'node<span class="operator">,</span>'leaf<span class="operator">)</span> <span class="module">Disk_node.</span>dnode

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'v</span><span class="operator">,</span><span class="type">'r</span><span class="operator">,</span><span class="type">'leaf</span><span class="operator">,</span><span class="type">'frame</span><span class="operator">,</span><span class="type">'t</span><span class="operator">)</span><span class="type"> pre_map_ops</span> <span class="operator">=</span> <span class="operator">{</span>
 find<span class="operator">:</span> <span class="label">r</span><span class="operator">:</span>'r <span class="operator">-&gt;</span> <span class="label">k</span><span class="operator">:</span>'k <span class="operator">-&gt;</span> <span class="operator">(</span>'r <span class="operator">*</span> 'leaf <span class="operator">*</span> 'frame list<span class="operator">,</span>'t<span class="operator">)</span> m<span class="operator">;</span>
 insert<span class="operator">:</span> <span class="label">r</span><span class="operator">:</span>'r <span class="operator">-&gt;</span> <span class="label">k</span><span class="operator">:</span>'k <span class="operator">-&gt;</span> <span class="label">v</span><span class="operator">:</span>'v <span class="operator">-&gt;</span> <span class="operator">(</span>'r option<span class="operator">,</span>'t<span class="operator">)</span> m<span class="operator">;</span>
 delete<span class="operator">:</span> <span class="label">r</span><span class="operator">:</span>'r <span class="operator">-&gt;</span> <span class="label">k</span><span class="operator">:</span>'k <span class="operator">-&gt;</span> <span class="operator">(</span>'r<span class="operator">,</span>'t<span class="operator">)</span> m<span class="operator">;</span>
<span class="operator">}</span>


<span class="comment-delimiter">(* </span><span class="comment">node ops --------------------------------------------------------- </span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">NOTE defn. in Isabelle </span><span class="comment-delimiter">*)</span>
<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">,</span><span class="type">'node</span><span class="operator">)</span><span class="type"> node_ops'</span> <span class="operator">=</span> <span class="operator">(</span>'k<span class="operator">,</span>'r<span class="operator">,</span>'node<span class="operator">)</span> <span class="module">Disk_node.</span>node_ops

<span class="comment-delimiter">(* </span><span class="comment">As Isabelle defn. See \doc(doc:node_ops) </span><span class="comment-delimiter">*)</span>
<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">,</span><span class="type">'node</span><span class="operator">)</span><span class="type"> node_ops</span> <span class="operator">=</span> <span class="operator">{</span>
  split_node_at_k_index<span class="operator">:</span> int <span class="operator">-&gt;</span> 'node <span class="operator">-&gt;</span> <span class="operator">(</span>'node<span class="operator">*</span>'k<span class="operator">*</span>'node<span class="operator">);</span>
  node_merge<span class="operator">:</span> 'node<span class="operator">*</span>'k<span class="operator">*</span>'node <span class="operator">-&gt;</span> 'node<span class="operator">;</span>
  node_steal_right<span class="operator">:</span> 'node<span class="operator">*</span>'k<span class="operator">*</span>'node <span class="operator">-&gt;</span> 'node<span class="operator">*</span>'k<span class="operator">*</span>'node<span class="operator">;</span>
  node_steal_left<span class="operator">:</span> 'node<span class="operator">*</span>'k<span class="operator">*</span>'node <span class="operator">-&gt;</span> 'node<span class="operator">*</span>'k<span class="operator">*</span>'node<span class="operator">;</span>
  node_keys_length<span class="operator">:</span> 'node <span class="operator">-&gt;</span> int<span class="operator">;</span>
  node_make_small_root<span class="operator">:</span> 'r<span class="operator">*</span>'k<span class="operator">*</span>'r <span class="operator">-&gt;</span> 'node<span class="operator">;</span>
  node_get_single_r<span class="operator">:</span> 'node <span class="operator">-&gt;</span> 'r<span class="operator">;</span>
<span class="operator">}</span>

<span class="comment-delimiter">(*  </span><span class="comment">node_dest_cons: 'node -&gt; 'r * 'k * 'node;  (* NOTE only for a node *)
  node_dest_snoc: 'node -&gt; 'node * 'k * 'r;  (* NOTE only for a node *) </span><span class="comment-delimiter">*)</span>

<span class="governing">open </span><span class="module">Tjr_fs_shared</span>

<span class="comment-delimiter">(* </span><span class="comment">implement node ops using a map from option; see impl notes in \doc(doc:node_ops) </span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">None is less than any other lower bound; this corresponds to the
   &quot;lowest&quot; interval below k0 </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="governing">rec</span> <span class="function-name">key_compare</span><span class="variable-name"> k_cmp k1 k2</span> <span class="operator">=</span>
  <span class="keyword">match</span> k1<span class="operator">,</span>k2 <span class="keyword">with</span> 
  <span class="operator">|</span> <span class="constructor">None</span><span class="operator">,</span><span class="constructor">None</span> <span class="operator">-&gt;</span> 0
  <span class="operator">|</span> <span class="constructor">None</span><span class="operator">,</span>_ <span class="operator">-&gt;</span> <span class="operator">-</span>1
  <span class="operator">|</span> _<span class="operator">,</span><span class="constructor">None</span> <span class="operator">-&gt;</span> 1
  <span class="operator">|</span> <span class="constructor">Some</span> k1<span class="operator">,</span> <span class="constructor">Some</span> k2 <span class="operator">-&gt;</span> k_cmp k1 k2

<span class="governing">let</span> <span class="function-name">dest_Some</span><span class="variable-name"> x</span> <span class="operator">=</span> <span class="keyword">match</span> x <span class="keyword">with</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> x <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="string">&quot;dest_Some&quot;</span>

<span class="governing">let</span> <span class="function-name">make_node_ops</span><span class="variable-name"> </span><span class="operator">(</span><span class="keyword">type</span><span class="variable-name"> </span><span class="type">k</span><span class="variable-name"> </span><span class="type">r</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">k_cmp</span> <span class="operator">=</span> 
  <span class="governing">let</span> <span class="variable-name">map_ops</span> <span class="operator">=</span> <span class="module">Tjr_poly_map.</span>make_map_ops <span class="operator">(</span>key_compare k_cmp<span class="operator">)</span> <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">make_node</span><span class="variable-name"> ks rs</span> <span class="operator">=</span> 
    <span class="keyword">assert</span><span class="operator">(</span><span class="module">List.</span>length rs <span class="operator">=</span> 1 <span class="operator">+</span> <span class="module">List.</span>length ks<span class="operator">);</span>
    <span class="governing">let</span> <span class="variable-name">ks</span> <span class="operator">=</span> <span class="constructor">None</span><span class="operator">::(</span><span class="module">List.</span>map <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">x</span> <span class="operator">-&gt;</span> <span class="constructor">Some</span> x<span class="operator">)</span> ks<span class="operator">)</span> <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">krs</span> <span class="operator">=</span> <span class="module">List.</span>combine ks rs <span class="governing">in</span>
    map_ops.of_bindings krs
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> make_node <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">split_node_at_k_index</span><span class="variable-name"> i n</span> <span class="operator">=</span>   <span class="comment-delimiter">(* </span><span class="comment">i counts from 0 </span><span class="comment-delimiter">*)</span>
    map_ops.bindings n <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">krs</span> <span class="operator">-&gt;</span> 
    <span class="governing">let</span> <span class="variable-name">ks</span><span class="operator">,</span><span class="variable-name">rs</span> <span class="operator">=</span> <span class="module">List.</span>split krs <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">ks</span> <span class="operator">=</span> <span class="module">List.</span>tl ks <span class="operator">|&gt;</span> <span class="module">List.</span>map dest_Some <span class="governing">in</span>  <span class="comment-delimiter">(* </span><span class="comment">drop None </span><span class="comment-delimiter">*)</span>
    <span class="governing">let</span> <span class="variable-name">k</span> <span class="operator">=</span> <span class="module">List.</span>nth ks i <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">r</span> <span class="operator">=</span> map_ops.find_opt <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> n <span class="operator">|&gt;</span> dest_Some <span class="governing">in</span>
    <span class="governing">let</span> <span class="operator">(</span><span class="variable-name">n1</span><span class="operator">,</span><span class="variable-name">_</span><span class="operator">,</span><span class="variable-name">n2</span><span class="operator">)</span> <span class="operator">=</span> map_ops.split <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> n <span class="governing">in</span>
    n2 <span class="operator">|&gt;</span> map_ops.add <span class="constructor">None</span> r <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n2</span> <span class="operator">-&gt;</span>
    <span class="operator">(</span>n1<span class="operator">,</span>k<span class="operator">,</span>n2<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_merge</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">n1</span><span class="operator">,</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">n2</span><span class="operator">)</span> <span class="operator">=</span> 
    n2 <span class="operator">|&gt;</span> map_ops.find_opt <span class="constructor">None</span> <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">r2</span> <span class="operator">-&gt;</span> 
    n2 <span class="operator">|&gt;</span> map_ops.remove <span class="constructor">None</span> <span class="operator">|&gt;</span> map_ops.add <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> r2 <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n2</span> <span class="operator">-&gt;</span>
    map_ops.disjoint_union n1 n2
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_steal_right</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">n1</span><span class="operator">,</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">n2</span><span class="operator">)</span> <span class="operator">=</span>
    n2 <span class="operator">|&gt;</span> map_ops.find_opt <span class="constructor">None</span> <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">r2</span> <span class="operator">-&gt;</span>
    n2 <span class="operator">|&gt;</span> map_ops.remove <span class="constructor">None</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n2</span> <span class="operator">-&gt;</span>
    n1 <span class="operator">|&gt;</span> map_ops.add <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> r2 <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n1</span> <span class="operator">-&gt;</span>
    n2 <span class="operator">|&gt;</span> map_ops.min_binding_opt <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">_</span><span class="operator">)</span> <span class="operator">-&gt;</span>
    k <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">k</span> <span class="operator">-&gt;</span>
    <span class="operator">(</span>n1<span class="operator">,</span>k<span class="operator">,</span>n2<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_steal_left</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">n1</span><span class="operator">,</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">n2</span><span class="operator">)</span> <span class="operator">=</span> 
    n1 <span class="operator">|&gt;</span> map_ops.max_binding_opt <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">r</span><span class="operator">)</span> <span class="operator">-&gt;</span>
    k <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">k</span> <span class="operator">-&gt;</span>
    n1 <span class="operator">|&gt;</span> map_ops.remove <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n1</span> <span class="operator">-&gt;</span>
    n2 <span class="operator">|&gt;</span> map_ops.add <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> r <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n2</span> <span class="operator">-&gt;</span>
    <span class="operator">(</span>n1<span class="operator">,</span>k<span class="operator">,</span>n2<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_keys_length</span><span class="variable-name"> n</span> <span class="operator">=</span> 
    <span class="operator">(</span>map_ops.cardinal n<span class="operator">)</span> <span class="operator">-</span>1
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_make_small_root</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">r1</span><span class="operator">,</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">r2</span><span class="operator">)</span> <span class="operator">=</span>
    map_ops.empty <span class="operator">|&gt;</span> map_ops.add <span class="constructor">None</span> r1 <span class="operator">|&gt;</span> map_ops.add <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> r2
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_get_single_r</span><span class="variable-name"> n</span> <span class="operator">=</span>
    <span class="keyword">assert</span><span class="operator">(</span>map_ops.cardinal n <span class="operator">=</span> 1<span class="operator">);</span>
    map_ops.bindings n <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">[(</span>_<span class="operator">,</span>r<span class="operator">)]</span> <span class="operator">-&gt;</span> r
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> node_steal_right <span class="governing">in</span>
  <span class="operator">{</span> split_node_at_k_index<span class="operator">;</span> node_merge<span class="operator">;</span> node_steal_right<span class="operator">;</span> node_steal_left<span class="operator">;</span> node_keys_length<span class="operator">;</span>
    node_make_small_root<span class="operator">;</span> node_get_single_r <span class="operator">}</span>

<span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">:</span><span class="type">
</span><span class="label">k_cmp</span><span class="operator">:(</span><span class="type">'a </span><span class="operator">-&gt;</span><span class="type"> 'a </span><span class="operator">-&gt;</span><span class="type"> int</span><span class="operator">)</span><span class="type"> </span><span class="operator">-&gt;</span><span class="type">
</span><span class="operator">(</span><span class="type">'a</span><span class="operator">,</span><span class="type"> 'b</span><span class="operator">,</span><span class="type"> </span><span class="operator">(</span><span class="type">'a option</span><span class="operator">,</span><span class="type"> 'b</span><span class="operator">,</span><span class="type"> 'c</span><span class="operator">)</span><span class="type"> </span><span class="module">Tjr_poly_map.</span><span class="type">map</span><span class="operator">)</span><span class="type"> node_ops
</span><span class="operator">=</span> make_node_ops


<span class="comment-delimiter">(* </span><span class="comment">frame_ops -------------------------------------------------------- </span><span class="comment-delimiter">*)</span>

<span class="comment-delimiter">(* </span><span class="comment">See Isabelle defn. See \doc(doc:frame_ops) </span><span class="comment-delimiter">*)</span>

<span class="governing">type</span> <span class="type">'k or_top</span> <span class="operator">=</span> 'k option

<span class="governing">type</span> <span class="type">'k or_bottom</span> <span class="operator">=</span> 'k option

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">)</span><span class="type"> segment</span> <span class="operator">=</span> 'k or_bottom <span class="operator">*</span> 'r <span class="operator">*</span> <span class="operator">(</span>'k<span class="operator">*</span>'r<span class="operator">)</span> list <span class="operator">*</span> 'k or_top

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">,</span><span class="type">'frame</span><span class="operator">,</span><span class="type">'node</span><span class="operator">)</span><span class="type"> frame_ops</span> <span class="operator">=</span> <span class="operator">{</span>
  split_node_on_key<span class="operator">:</span> 'r <span class="operator">-&gt;</span> 'k <span class="operator">-&gt;</span> 'node <span class="operator">-&gt;</span> 'frame<span class="operator">;</span>
  midpoint<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> 'r<span class="operator">;</span>

  get_focus<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> <span class="operator">(</span>'k or_bottom <span class="operator">*</span> 'r <span class="operator">*</span> 'k or_top<span class="operator">);</span>
  get_focus_and_right_sibling<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> <span class="operator">(</span>'k or_bottom <span class="operator">*</span> 'r <span class="operator">*</span> 'k <span class="operator">*</span> 'r <span class="operator">*</span> 'k or_top<span class="operator">)</span> option<span class="operator">;</span>
  get_left_sibling_and_focus<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> <span class="operator">(</span>'k or_bottom <span class="operator">*</span> 'r <span class="operator">*</span> 'k <span class="operator">*</span> 'r <span class="operator">*</span> 'k or_top<span class="operator">)</span> option<span class="operator">;</span>
  replace<span class="operator">:</span> <span class="operator">(</span>'k<span class="operator">,</span>'r<span class="operator">)</span> segment <span class="operator">-&gt;</span> <span class="operator">(</span>'k<span class="operator">,</span>'r<span class="operator">)</span> segment <span class="operator">-&gt;</span> 'frame <span class="operator">-&gt;</span> 'frame<span class="operator">;</span>
  frame_to_node<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> 'node<span class="operator">;</span>

  get_midpoint_bounds<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> <span class="operator">(</span>'k option <span class="operator">*</span> 'k option<span class="operator">);</span>
  backing_node_blk_ref<span class="operator">:</span> 'frame <span class="operator">-&gt;</span> 'r<span class="operator">;</span>
<span class="operator">}</span>

<span class="comment-delimiter">(* </span><span class="comment">FIXME maybe move elsewhere </span><span class="comment-delimiter">*)</span>

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'r</span><span class="operator">,</span><span class="type">'node</span><span class="operator">)</span><span class="type"> frame</span> <span class="operator">=</span> <span class="operator">{</span>
  midkey<span class="operator">:</span> 'k option<span class="operator">;</span>  <span class="comment-delimiter">(* </span><span class="comment">may be None </span><span class="comment-delimiter">*)</span>
  midpoint<span class="operator">:</span> 'r<span class="operator">;</span>
  node<span class="operator">:</span> 'node<span class="operator">;</span>
  backing_node_blk_ref<span class="operator">:</span> 'r
<span class="operator">}</span>

<span class="governing">let</span> <span class="function-name">make_frame_ops</span><span class="variable-name"> </span><span class="operator">(</span><span class="keyword">type</span><span class="variable-name"> </span><span class="type">k</span><span class="variable-name"> </span><span class="type">r</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">k_cmp</span><span class="operator">:</span><span class="type">k</span><span class="operator">-&gt;</span><span class="type">k</span><span class="operator">-&gt;</span><span class="type">int</span><span class="operator">)</span> <span class="operator">=</span> 
  <span class="governing">let</span> <span class="variable-name">map_ops</span> <span class="operator">=</span> <span class="module">Tjr_poly_map.</span>make_map_ops <span class="operator">(</span>key_compare k_cmp<span class="operator">)</span> <span class="governing">in</span>
  <span class="module">Tjr_fs_shared.Map_with_key_traversal.</span>make_ops <span class="operator">~</span>map_ops <span class="operator">@@</span> <span class="keyword">fun</span> <span class="operator">~</span><span class="variable-name">get_next_binding </span><span class="operator">~</span><span class="variable-name">get_prev_binding</span> <span class="operator">-&gt;</span>
  <span class="comment-delimiter">(* </span><span class="comment">map_ops is a map from 'k option </span><span class="comment-delimiter">*)</span>
  <span class="governing">let</span> <span class="function-name">split_node_on_key</span><span class="variable-name"> backing_node_blk_ref k n</span> <span class="operator">=</span> 
    <span class="comment-delimiter">(* </span><span class="comment">get the relevant key </span><span class="comment-delimiter">*)</span>
    <span class="governing">let</span> <span class="variable-name">midkey</span><span class="operator">,</span><span class="variable-name">midpoint</span> <span class="operator">=</span> 
      map_ops.find_opt <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> n <span class="operator">|&gt;</span> <span class="keyword">function</span>
      <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> get_prev_binding <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> n <span class="operator">|&gt;</span> dest_Some <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">r</span><span class="operator">)</span> <span class="operator">-&gt;</span>
                <span class="operator">(</span>k<span class="operator">,</span>r<span class="operator">)</span>
      <span class="operator">|</span> <span class="constructor">Some</span> r <span class="operator">-&gt;</span> <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">,(</span>r<span class="operator">:</span><span class="type">r</span><span class="operator">))</span>
    <span class="governing">in</span>
    <span class="operator">{</span> midkey<span class="operator">;</span> midpoint<span class="operator">;</span> backing_node_blk_ref<span class="operator">;</span> node<span class="operator">=</span>n <span class="operator">}</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> split_node_on_key <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">midpoint</span><span class="variable-name"> f</span> <span class="operator">=</span> f.midpoint <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">get_focus</span><span class="variable-name"> f</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="variable-name">k1</span> <span class="operator">=</span> f.midkey <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">k2</span> <span class="operator">=</span> f.node <span class="operator">|&gt;</span> get_next_binding f.midkey <span class="operator">|&gt;</span> <span class="keyword">function</span> 
      <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constructor">None</span> 
      <span class="operator">|</span> <span class="constructor">Some</span> <span class="operator">(</span>k<span class="operator">,</span>r<span class="operator">)</span> <span class="operator">-&gt;</span> k
    <span class="governing">in</span>
    <span class="operator">(</span>k1<span class="operator">,</span>f.midpoint<span class="operator">,</span>k2<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">get_focus_and_right_sibling</span><span class="variable-name"> f</span> <span class="operator">=</span>
    <span class="governing">let</span> <span class="variable-name">k1</span><span class="operator">,</span><span class="variable-name">r1</span> <span class="operator">=</span> f.midkey<span class="operator">,</span>f.midpoint <span class="governing">in</span>
    f.node <span class="operator">|&gt;</span> get_next_binding f.midkey <span class="operator">|&gt;</span> <span class="keyword">function</span>
    <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constructor">None</span>
    <span class="operator">|</span> <span class="constructor">Some</span> <span class="operator">(</span>k2<span class="operator">,</span>r2<span class="operator">)</span> <span class="operator">-&gt;</span> 
      <span class="governing">let</span> <span class="variable-name">k2</span> <span class="operator">=</span> k2 <span class="operator">|&gt;</span> dest_Some <span class="governing">in</span>
      <span class="comment-delimiter">(* </span><span class="comment">NOTE as a hack, we just return None for k3, since it is never used... </span><span class="comment-delimiter">*)</span>
      <span class="constructor">Some</span><span class="operator">(</span>k1<span class="operator">,</span>r1<span class="operator">,</span>k2<span class="operator">,</span>r2<span class="operator">,</span><span class="constructor">None</span><span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">get_left_sibling_and_focus</span><span class="variable-name"> f</span> <span class="operator">=</span> 
    f.node <span class="operator">|&gt;</span> get_prev_binding f.midkey <span class="operator">|&gt;</span> <span class="keyword">function</span>
    <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constructor">None</span> 
    <span class="operator">|</span> <span class="constructor">Some</span><span class="operator">(</span>k1<span class="operator">,</span>r1<span class="operator">)</span> <span class="operator">-&gt;</span>
      <span class="governing">let</span> <span class="variable-name">k2</span><span class="operator">,</span><span class="variable-name">r2</span> <span class="operator">=</span> f.midkey<span class="operator">,</span>f.midpoint <span class="governing">in</span>
      <span class="governing">let</span> <span class="variable-name">k2</span> <span class="operator">=</span> k2 <span class="operator">|&gt;</span> dest_Some <span class="governing">in</span>
      <span class="comment-delimiter">(* </span><span class="comment">NOTE hack </span><span class="comment-delimiter">*)</span>
      <span class="constructor">Some</span><span class="operator">(</span>k1<span class="operator">,</span>r1<span class="operator">,</span>k2<span class="operator">,</span>r2<span class="operator">,</span><span class="constructor">None</span><span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">replace</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">k</span><span class="operator">,</span><span class="variable-name">r</span><span class="operator">,</span><span class="variable-name">krs</span><span class="operator">,</span><span class="variable-name">_</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">k'</span><span class="operator">,</span><span class="variable-name">r'</span><span class="operator">,</span><span class="variable-name">krs'</span><span class="operator">,</span><span class="variable-name">_</span><span class="operator">)</span><span class="variable-name"> f</span> <span class="operator">=</span>
    <span class="keyword">assert</span><span class="operator">(</span>key_compare k_cmp k k' <span class="operator">=</span> 0<span class="operator">);</span>
    f.node <span class="operator">|&gt;</span> map_ops.add k' r' <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n</span> <span class="operator">-&gt;</span>
    <span class="comment-delimiter">(* </span><span class="comment">remove old ks </span><span class="comment-delimiter">*)</span>
    <span class="operator">(</span>krs<span class="operator">,</span>n<span class="operator">)</span> 
    <span class="operator">|&gt;</span> <span class="module">Tjr_list.</span>iter_opt <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">krs</span><span class="operator">,</span><span class="variable-name">n</span><span class="operator">)</span> <span class="operator">-&gt;</span>
      <span class="keyword">match</span> krs <span class="keyword">with</span> 
      <span class="operator">|</span> <span class="operator">[]</span> <span class="operator">-&gt;</span> <span class="constructor">None</span>
      <span class="operator">|</span> <span class="operator">(</span>k<span class="operator">,</span>r<span class="operator">)::</span>krs <span class="operator">-&gt;</span>
        n <span class="operator">|&gt;</span> map_ops.remove <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n</span> <span class="operator">-&gt;</span> <span class="constructor">Some</span><span class="operator">(</span>krs<span class="operator">,</span>n<span class="operator">))</span>
    <span class="operator">|&gt;</span> snd
    <span class="comment-delimiter">(* </span><span class="comment">add new krs </span><span class="comment-delimiter">*)</span>
    <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n</span> <span class="operator">-&gt;</span>
    <span class="operator">(</span>krs'<span class="operator">,</span>n<span class="operator">)</span> 
    <span class="operator">|&gt;</span> <span class="module">Tjr_list.</span>iter_opt <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">krs</span><span class="operator">,</span><span class="variable-name">n</span><span class="operator">)</span> <span class="operator">-&gt;</span> 
      <span class="keyword">match</span> krs <span class="keyword">with</span>
      <span class="operator">|</span> <span class="operator">[]</span> <span class="operator">-&gt;</span> <span class="constructor">None</span>
      <span class="operator">|</span> <span class="operator">(</span>k<span class="operator">,</span>r<span class="operator">)::</span>krs <span class="operator">-&gt;</span>
        n <span class="operator">|&gt;</span> map_ops.add <span class="operator">(</span><span class="constructor">Some</span> k<span class="operator">)</span> r <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">n</span> <span class="operator">-&gt;</span> <span class="constructor">Some</span><span class="operator">(</span>krs<span class="operator">,</span>n<span class="operator">))</span>
    <span class="operator">|&gt;</span> snd
    <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">node</span> <span class="operator">-&gt;</span>
    <span class="operator">{</span> f <span class="keyword">with</span> node <span class="operator">}</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">frame_to_node</span><span class="variable-name"> f</span> <span class="operator">=</span> f.node <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">get_midpoint_bounds</span><span class="variable-name"> f</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="variable-name">l</span> <span class="operator">:</span> <span class="type">k option </span><span class="operator">=</span> f.midkey <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">u</span> <span class="operator">=</span> f.node <span class="operator">|&gt;</span> get_next_binding f.midkey <span class="operator">|&gt;</span> <span class="keyword">function</span>
      <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="constructor">None</span>
      <span class="operator">|</span> <span class="constructor">Some</span> <span class="operator">(</span>k<span class="operator">,</span>r<span class="operator">)</span> <span class="operator">-&gt;</span> <span class="operator">(</span>k<span class="operator">:</span><span class="type">k option</span><span class="operator">)</span>
    <span class="governing">in</span>
    <span class="operator">(</span>l<span class="operator">,</span>u<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">backing_node_blk_ref</span><span class="variable-name"> f</span> <span class="operator">=</span> f.backing_node_blk_ref <span class="governing">in</span>
  <span class="operator">{</span> split_node_on_key<span class="operator">;</span> midpoint<span class="operator">;</span> get_focus<span class="operator">;</span> get_focus_and_right_sibling<span class="operator">;</span> 
    get_left_sibling_and_focus<span class="operator">;</span> replace<span class="operator">;</span> frame_to_node<span class="operator">;</span> get_midpoint_bounds<span class="operator">;</span>
    backing_node_blk_ref <span class="operator">}</span>
  
<span class="tuareg-font-double-colon-face">;;</span>
      

<span class="governing">let</span> <span class="function-name">_</span> <span class="operator">:</span>
k_cmp<span class="operator">:(</span>'a <span class="operator">-&gt;</span> 'a <span class="operator">-&gt;</span> int<span class="operator">)</span> <span class="operator">-&gt;</span>
<span class="operator">(</span>'a<span class="operator">,</span> 'b<span class="operator">,</span> <span class="operator">(</span>'a<span class="operator">,</span> 'b<span class="operator">,</span> <span class="operator">(</span>'a or_bottom<span class="operator">,</span> 'b<span class="operator">,</span> 'c<span class="operator">)</span> <span class="module">Tjr_poly_map.</span>map<span class="operator">)</span> frame<span class="operator">,</span>
 <span class="operator">(</span>'a or_bottom<span class="operator">,</span> 'b<span class="operator">,</span> 'c<span class="operator">)</span> <span class="module">Tjr_poly_map.</span>map<span class="operator">)</span>
frame_ops
 <span class="operator">=</span> make_frame_ops

<span class="tuareg-font-double-colon-face">;;</span>


<span class="governing">let</span> <span class="function-name">make_find_insert_delete</span><span class="variable-name"> </span><span class="operator">(</span><span class="keyword">type</span><span class="variable-name"> </span><span class="type">t</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">monad_ops</span><span class="operator">:</span><span class="type">t monad_ops</span><span class="operator">)</span> <span class="operator">=</span> 
  <span class="governing">let</span> <span class="governing">module</span> <span class="module">Monad</span> <span class="operator">=</span> <span class="governing">struct</span>
    <span class="governing">type</span> <span class="governing">nonrec</span> <span class="type">t</span> <span class="operator">=</span> t
    <span class="governing">type</span> <span class="operator">(</span><span class="type">'a</span><span class="operator">,</span><span class="type">'t</span><span class="operator">)</span><span class="type"> mm</span> <span class="operator">=</span> <span class="operator">(</span>'a<span class="operator">,</span>t<span class="operator">)</span> <span class="module">Tjr_monad.Types.</span>m 
    <span class="governing">let</span> <span class="function-name">bind</span><span class="variable-name"> ab a</span> <span class="operator">=</span> monad_ops.bind a ab
    <span class="governing">let</span> <span class="function-name">return</span><span class="variable-name"> a</span> <span class="operator">=</span> monad_ops.return a
    <span class="governing">let</span> <span class="function-name">fmap</span><span class="variable-name"> f a</span> <span class="operator">=</span> a <span class="operator">|&gt;</span> bind <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">a</span> <span class="operator">-&gt;</span> return <span class="operator">(</span>f a<span class="operator">))</span>
  <span class="governing">end</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="governing">module</span> <span class="module">M</span> <span class="operator">=</span> <span class="module">Isa_export.Make</span><span class="operator">(</span><span class="module">Monad</span><span class="operator">)</span> <span class="governing">in</span>
  <span class="comment-delimiter">(* </span><span class="comment">isa numbers:
type nat = Nat of Big_int.big_int;;
type int = Int_of_integer of Big_int.big_int;;
  </span><span class="comment-delimiter">*)</span>
  <span class="governing">let</span> <span class="function-name">int2nat</span><span class="variable-name"> n</span> <span class="operator">=</span> <span class="module">Arith.</span>nat_of_integer <span class="operator">(</span><span class="module">Big_int.</span>big_int_of_int n<span class="operator">)</span> <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">nat2bigint</span><span class="variable-name"> </span><span class="operator">(</span><span class="module">Arith.</span><span class="constructor">Nat</span><span class="variable-name"> n</span><span class="operator">)</span> <span class="operator">=</span> n <span class="governing">in</span>
  <span class="governing">let</span> <span class="variable-name">bigint2int</span> <span class="operator">=</span> <span class="module">Big_int.</span>int_of_big_int <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">nat2int</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">n</span><span class="operator">:</span><span class="module">Arith.</span><span class="type">nat</span><span class="operator">)</span> <span class="operator">=</span> n <span class="operator">|&gt;</span> nat2bigint <span class="operator">|&gt;</span> bigint2int <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">int2isa</span><span class="variable-name"> i</span> <span class="operator">=</span> <span class="module">Arith.</span><span class="constructor">Int_of_integer</span><span class="operator">(</span><span class="module">Big_int.</span>big_int_of_int i<span class="operator">)</span> <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">cs2isa</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">cs</span><span class="operator">:</span><span class="type">constants</span><span class="operator">)</span> <span class="operator">=</span> 
    <span class="module">Constants_and_size_types.</span>make_constants 
      <span class="operator">(</span>int2nat cs.min_leaf_size<span class="operator">)</span> 
      <span class="operator">(</span>int2nat cs.max_leaf_size<span class="operator">)</span>
      <span class="operator">(</span>int2nat cs.min_node_keys<span class="operator">)</span>
      <span class="operator">(</span>int2nat cs.max_node_keys<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">cmp2isa</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">f</span><span class="operator">:</span><span class="type"> 'k </span><span class="operator">-&gt;</span><span class="type"> 'k </span><span class="operator">-&gt;</span><span class="type"> int</span><span class="operator">)</span> <span class="operator">=</span> <span class="keyword">fun</span> <span class="variable-name">k1 k2</span> <span class="operator">-&gt;</span> f k1 k2 <span class="operator">|&gt;</span> int2isa <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">leaf_ops2isa</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">leaf_lookup</span><span class="operator">,</span><span class="variable-name">leaf_insert</span><span class="operator">,</span><span class="variable-name">leaf_remove</span><span class="operator">,</span><span class="variable-name">leaf_length</span><span class="operator">,</span><span class="variable-name">dbg_leaf_kvs</span><span class="operator">,</span><span class="variable-name">leaf_steal_right</span><span class="operator">,</span><span class="variable-name">leaf_steal_left</span><span class="operator">,</span><span class="variable-name">leaf_merge</span><span class="operator">,</span><span class="variable-name">split_large_leaf</span><span class="operator">)</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="function-name">leaf_length</span><span class="variable-name"> l</span> <span class="operator">=</span> leaf_length l <span class="operator">|&gt;</span> int2nat <span class="governing">in</span>
    <span class="module">Isa_export.Disk_node.</span><span class="constructor">Make_leaf_ops</span><span class="operator">(</span>leaf_lookup<span class="operator">,</span>leaf_insert<span class="operator">,</span>leaf_remove<span class="operator">,</span>leaf_length<span class="operator">,</span>dbg_leaf_kvs<span class="operator">,</span>leaf_steal_right<span class="operator">,</span>leaf_steal_left<span class="operator">,</span>leaf_merge<span class="operator">,</span>split_large_leaf<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">node_ops2isa</span><span class="variable-name"> node_ops</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="operator">{</span>split_node_at_k_index<span class="operator">;</span> node_merge<span class="operator">;</span> node_steal_right<span class="operator">;</span> node_steal_left<span class="operator">;</span> node_keys_length<span class="operator">;</span> node_make_small_root<span class="operator">;</span> node_get_single_r<span class="operator">}</span> <span class="operator">=</span> node_ops <span class="governing">in</span>
    <span class="module">Isa_export.Disk_node.</span><span class="constructor">Make_node_ops</span> <span class="operator">(</span>
      <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">nat n</span> <span class="operator">-&gt;</span> split_node_at_k_index <span class="operator">(</span>nat2int nat<span class="operator">)</span> n <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">x</span><span class="operator">,</span><span class="variable-name">y</span><span class="operator">,</span><span class="variable-name">z</span><span class="operator">)</span> <span class="operator">-&gt;</span> <span class="operator">(</span>x<span class="operator">,(</span>y<span class="operator">,</span>z<span class="operator">))),</span> 
      <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,(</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">))</span> <span class="operator">-&gt;</span> node_merge <span class="operator">(</span>a<span class="operator">,</span>b<span class="operator">,</span>c<span class="operator">)),</span> 
      <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,(</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">))</span> <span class="operator">-&gt;</span> node_steal_right <span class="operator">(</span>a<span class="operator">,</span>b<span class="operator">,</span>c<span class="operator">)</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">)</span> <span class="operator">-&gt;</span> <span class="operator">(</span>a<span class="operator">,(</span>b<span class="operator">,</span>c<span class="operator">))),</span> 
      <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,(</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">))</span> <span class="operator">-&gt;</span> node_steal_left <span class="operator">(</span>a<span class="operator">,</span>b<span class="operator">,</span>c<span class="operator">)</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">)</span> <span class="operator">-&gt;</span> <span class="operator">(</span>a<span class="operator">,(</span>b<span class="operator">,</span>c<span class="operator">))),</span> 
      <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">x</span> <span class="operator">-&gt;</span> x <span class="operator">|&gt;</span> node_keys_length <span class="operator">|&gt;</span> int2nat<span class="operator">),</span> 
      <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,(</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">))</span> <span class="operator">-&gt;</span> node_make_small_root <span class="operator">(</span>a<span class="operator">,</span>b<span class="operator">,</span>c<span class="operator">)),</span> 
      node_get_single_r<span class="operator">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">frame_ops2isa</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">left_half</span><span class="operator">,</span><span class="variable-name">right_half</span><span class="operator">,</span><span class="variable-name">midpoint</span><span class="operator">,</span><span class="variable-name">rh_dest_cons</span><span class="operator">,</span><span class="variable-name">lh_dest_snoc</span><span class="operator">,</span><span class="variable-name">unsplit</span><span class="operator">,</span><span class="variable-name">get_midpoint_bounds</span><span class="operator">,</span><span class="variable-name">split_node_on_key</span><span class="operator">,</span><span class="variable-name">original_node_r</span><span class="operator">,</span><span class="variable-name">split_node_on_first_key</span><span class="operator">,</span><span class="variable-name">step_frame_for_ls</span><span class="operator">)</span> <span class="operator">=</span> 
    <span class="merlin-compilation-error-face-0000">Isa_export.Stacks_and_frames.</span><span class="merlin-compilation-error-face-0001">Make_frame_ops</span><span class="merlin-compilation-error-face-0002">(</span><span class="merlin-compilation-error-face-0003">left_half</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">right_half</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">midpoint</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">rh_dest_cons</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">lh_dest_snoc</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">unsplit</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">get_midpoint_bounds</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">split_node_on_key</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">original_node_r</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">split_node_on_first_key</span><span class="merlin-compilation-error-face-0002">,</span><span class="merlin-compilation-error-face-0003">step_frame_for_ls</span><span class="merlin-compilation-error-face-0002">)</span>
  <span class="governing">in</span>
  <span class="governing">let</span> <span class="function-name">store_ops2isa</span><span class="variable-name"> store_ops</span> <span class="operator">=</span> 
    <span class="governing">let</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">,</span><span class="variable-name">d</span><span class="operator">)</span> <span class="operator">=</span> store_ops <span class="governing">in</span>
    <span class="module">M.Post_monad.</span>make_store_ops a b c d
  <span class="governing">in</span>
  <span class="keyword">fun</span> <span class="operator">~</span>cs <span class="operator">~</span>k_cmp
    <span class="operator">~</span>leaf_ops
    <span class="operator">~</span>node_ops
    <span class="operator">~</span>frame_ops
    <span class="operator">~</span>store_ops
    <span class="operator">~</span>check_tree_at_r'
    <span class="operator">-&gt;</span> 
    <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> leaf_ops <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">find</span>  <span class="operator">=</span> 
      <span class="governing">let</span> <span class="variable-name">find</span> <span class="operator">=</span> <span class="module">M.Find.</span>find <span class="operator">(</span>frame_ops2isa frame_ops<span class="operator">)</span> <span class="operator">(</span>store_ops2isa store_ops<span class="operator">)</span> <span class="governing">in</span>
      <span class="keyword">fun</span> <span class="operator">~(</span><span class="variable-name">r</span><span class="operator">:</span><span class="type">'r</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">k</span><span class="operator">:</span><span class="type">'k</span><span class="operator">)</span> <span class="operator">-&gt;</span> find r k <span class="operator">|&gt;</span> <span class="module">Monad.</span>fmap <span class="operator">(</span><span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">a</span><span class="operator">,(</span><span class="variable-name">b</span><span class="operator">,</span><span class="variable-name">c</span><span class="operator">))</span> <span class="operator">-&gt;</span> <span class="operator">(</span>a<span class="operator">,</span>b<span class="operator">,</span>c<span class="operator">))</span>
    <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">insert</span> <span class="operator">=</span> 
      <span class="governing">let</span> <span class="variable-name">insert</span> <span class="operator">=</span> <span class="module">M.Insert.</span>insert <span class="operator">(</span>cs2isa cs<span class="operator">)</span> <span class="operator">(</span>leaf_ops2isa leaf_ops<span class="operator">)</span> <span class="operator">(</span>node_ops2isa node_ops<span class="operator">)</span> <span class="operator">(</span>frame_ops2isa frame_ops<span class="operator">)</span> <span class="operator">(</span>store_ops2isa store_ops<span class="operator">)</span> check_tree_at_r' <span class="governing">in</span>
      <span class="keyword">fun</span>  <span class="operator">~(</span><span class="variable-name">r</span><span class="operator">:</span><span class="type">'r</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">k</span><span class="operator">:</span><span class="type">'k</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">v</span><span class="operator">:</span><span class="type">'v</span><span class="operator">)</span> <span class="operator">-&gt;</span> insert r k v
    <span class="governing">in</span>
    <span class="governing">let</span> <span class="variable-name">delete</span>  <span class="operator">=</span>
      <span class="governing">let</span> <span class="variable-name">delete</span> <span class="operator">=</span> <span class="module">M.Delete.</span>delete <span class="operator">(</span>cs2isa cs<span class="operator">)</span> <span class="operator">(</span>leaf_ops2isa leaf_ops<span class="operator">)</span>  <span class="operator">(</span>node_ops2isa node_ops<span class="operator">)</span> <span class="operator">(</span>frame_ops2isa frame_ops<span class="operator">)</span> <span class="operator">(</span>store_ops2isa store_ops<span class="operator">)</span> check_tree_at_r' <span class="governing">in</span>
      <span class="keyword">fun</span> <span class="operator">~(</span><span class="variable-name">r</span><span class="operator">:</span><span class="type">'r</span><span class="operator">)</span><span class="variable-name"> </span><span class="operator">~(</span><span class="variable-name">k</span><span class="operator">:</span><span class="type">'k</span><span class="operator">)</span> <span class="operator">-&gt;</span> delete r k
    <span class="governing">in</span>
    <span class="operator">{</span>find<span class="operator">;</span>insert<span class="operator">;</span>delete<span class="operator">}</span>

<span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> make_find_insert_delete
</pre>

 </body>
</html>
