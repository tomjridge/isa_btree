%
\begin{isabellebody}%
\setisabellecontext{Insert{\isacharunderscore}many}%
%
\isadelimtheory
%
\endisadelimtheory
%
\isatagtheory
\isacommand{theory}\isamarkupfalse%
\ Insert{\isacharunderscore}many\isanewline
\isakeyword{imports}\ Find\ {\isachardoublequoteopen}{\isachardollar}SRC{\isacharslash}c{\isacharunderscore}monad{\isacharslash}Insert{\isacharunderscore}many{\isacharunderscore}state{\isachardoublequoteclose}\isanewline
\isakeyword{begin}%
\endisatagtheory
{\isafoldtheory}%
%
\isadelimtheory
\isanewline
%
\endisadelimtheory
\isanewline
\isanewline
\isacommand{type{\isacharunderscore}synonym}\isamarkupfalse%
\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ fo\ {\isacharequal}\ {\isachardoublequoteopen}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ im{\isacharunderscore}fo{\isachardoublequoteclose}\isanewline
\isanewline
\isacommand{type{\isacharunderscore}synonym}\isamarkupfalse%
\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ d\ {\isacharequal}\ {\isachardoublequoteopen}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}fs\ {\isacharasterisk}\ {\isacharparenleft}{\isacharprime}v\ {\isacharasterisk}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s{\isacharparenright}{\isachardoublequoteclose}\isanewline
\isanewline
\isacommand{type{\isacharunderscore}synonym}\isamarkupfalse%
\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ u\ {\isacharequal}\ {\isachardoublequoteopen}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}fo{\isacharasterisk}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}r{\isacharparenright}rstk{\isachardoublequoteclose}\isanewline
\isanewline
\isanewline
\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ step{\isacharunderscore}down\ {\isacharcolon}{\isacharcolon}\ {\isachardoublequoteopen}{\isacharprime}k\ ps{\isadigit{1}}\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharcomma}{\isacharprime}t{\isacharparenright}\ store{\isacharunderscore}ops\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}d\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ d{\isacharcomma}{\isacharprime}t{\isacharparenright}\ MM{\isachardoublequoteclose}\ \isakeyword{where}\isanewline
{\isachardoublequoteopen}step{\isacharunderscore}down\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ d\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ let\ {\isacharparenleft}fs{\isacharcomma}v{\isacharparenright}\ {\isacharequal}\ d\ in\isanewline
\ \ find{\isacharunderscore}step\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ fs\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ d{\isacharprime}{\isachardot}\ {\isacharparenleft}d{\isacharprime}{\isacharcomma}v{\isacharparenright}{\isacharparenright}\isanewline
{\isacharparenright}{\isachardoublequoteclose}\isanewline
\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ kvs{\isacharunderscore}insert{\isacharunderscore}{\isadigit{2}}\ {\isacharcolon}{\isacharcolon}\ \isanewline
\ \ {\isachardoublequoteopen}constants\ {\isasymRightarrow}\ {\isacharprime}k\ ord\ {\isasymRightarrow}\ {\isacharprime}k\ option\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s\ {\isacharasterisk}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s{\isachardoublequoteclose}\ \isanewline
\isakeyword{where}\isanewline
{\isachardoublequoteopen}kvs{\isacharunderscore}insert{\isacharunderscore}{\isadigit{2}}\ cs{\isacharprime}\ k{\isacharunderscore}ord\ u\ kv\ new\ existing\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ let\ cs\ {\isacharequal}\ cs{\isacharprime}\ in\isanewline
\ \ let\ step\ {\isacharequal}\ {\isacharparenleft}{\isacharpercent}\ s{\isachardot}\ \isanewline
\ \ \ \ let\ {\isacharparenleft}acc{\isacharcomma}new{\isacharprime}{\isacharparenright}\ {\isacharequal}\ s\ in\isanewline
\ \ \ \ case\ {\isacharparenleft}length\ acc\ {\isasymge}\ {\isadigit{2}}\ {\isacharasterisk}\ cs{\isacharbar}{\isachargreater}max{\isacharunderscore}leaf{\isacharunderscore}size{\isacharparenright}\ of\isanewline
\ \ \ \ True\ {\isasymRightarrow}\ None\isanewline
\ \ \ \ {\isacharbar}\ False\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ case\ new{\isacharprime}\ of\isanewline
\ \ \ \ \ \ {\isacharbrackleft}{\isacharbrackright}\ {\isasymRightarrow}\ None\isanewline
\ \ \ \ \ \ {\isacharbar}\ {\isacharparenleft}k{\isacharcomma}v{\isacharparenright}{\isacharhash}new{\isacharprime}{\isacharprime}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ \ \ let\ test\ {\isacharequal}\ {\isacharpercent}\ k\ u{\isachardot}\isanewline
\ \ \ \ \ \ \ \ \ \ {\isacharparenleft}{\isacharasterisk}\ {\isacharparenleft}check{\isacharunderscore}keys\ {\isacharparenleft}Params{\isachardot}the{\isacharunderscore}kv{\isacharunderscore}ops{\isacharbar}{\isachargreater}compare{\isacharunderscore}k{\isacharparenright}\ None\ {\isacharbraceleft}k{\isacharbraceright}\ u{\isacharparenright}\ {\isacharasterisk}{\isacharparenright}\ {\isacharparenleft}{\isacharasterisk}\ FIXME\ equality\ on\ keys\ in\ generated\ code\ {\isacharcolon}{\isacharparenleft}\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ \ \ \ \ \ \ \ \ case\ u\ of\ None\ {\isasymRightarrow}\ True\ {\isacharbar}\ Some\ u\ {\isasymRightarrow}\ key{\isacharunderscore}lt\ k{\isacharunderscore}ord\ k\ u\isanewline
\ \ \ \ \ \ \ \ in\isanewline
\ \ \ \ \ \ \ \ case\ test\ k\ u\ of\ \ \isanewline
\ \ \ \ \ \ \ \ True\ {\isasymRightarrow}\ {\isacharparenleft}Some{\isacharparenleft}kvs{\isacharunderscore}insert\ k{\isacharunderscore}ord\ {\isacharparenleft}k{\isacharcomma}v{\isacharparenright}\ acc{\isacharcomma}new{\isacharprime}{\isacharprime}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ \ \ \ \ {\isacharbar}\ False\ {\isasymRightarrow}\ {\isacharparenleft}None{\isacharparenright}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ in\isanewline
\ \ iter{\isacharunderscore}step\ step\ {\isacharparenleft}existing{\isacharcomma}new{\isacharparenright}{\isacharparenright}{\isachardoublequoteclose}\isanewline
\isanewline
\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ split{\isacharunderscore}leaf\ {\isacharcolon}{\isacharcolon}\ {\isachardoublequoteopen}constants\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s\ {\isacharasterisk}\ {\isacharprime}k\ {\isacharasterisk}\ {\isacharparenleft}{\isacharprime}k{\isacharasterisk}{\isacharprime}v{\isacharparenright}s{\isachardoublequoteclose}\ \isakeyword{where}\isanewline
{\isachardoublequoteopen}split{\isacharunderscore}leaf\ cs{\isadigit{0}}\ kvs\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ let\ n\ {\isacharequal}\ List{\isachardot}length\ kvs\ in\isanewline
\ \ let\ n{\isadigit{1}}\ {\isacharequal}\ n\ in\isanewline
\ \ let\ n{\isadigit{2}}\ {\isacharequal}\ {\isadigit{0}}\ in\isanewline
\ \ let\ delta\ {\isacharequal}\ cs{\isadigit{0}}{\isacharbar}{\isachargreater}min{\isacharunderscore}leaf{\isacharunderscore}size\ in\isanewline
\ \ let\ n{\isadigit{1}}\ {\isacharequal}\ n{\isadigit{1}}\ {\isacharminus}\ delta\ in\isanewline
\ \ let\ n{\isadigit{2}}\ {\isacharequal}\ n{\isadigit{2}}\ {\isacharplus}\ delta\ in\isanewline
\ \ let\ delta\ {\isacharequal}\ {\isacharparenleft}n{\isadigit{1}}\ {\isacharminus}\ cs{\isadigit{0}}{\isacharbar}{\isachargreater}max{\isacharunderscore}leaf{\isacharunderscore}size{\isacharparenright}\ in\isanewline
\ \ let\ n{\isadigit{1}}\ {\isacharequal}\ n{\isadigit{1}}\ {\isacharminus}\ delta\ in\isanewline
\ \ let\ n{\isadigit{2}}\ {\isacharequal}\ n{\isadigit{2}}\ {\isacharplus}\ delta\ in\isanewline
\ \ let\ {\isacharparenleft}l{\isacharcomma}r{\isacharparenright}\ {\isacharequal}\ split{\isacharunderscore}at\ n{\isadigit{1}}\ kvs\ in\isanewline
\ \ let\ k\ {\isacharequal}\ {\isacharparenleft}case\ r\ of\ {\isacharbrackleft}{\isacharbrackright}\ {\isasymRightarrow}\ impossible{\isadigit{1}}\ {\isacharparenleft}STR\ {\isacharprime}{\isacharprime}insert{\isacharunderscore}many{\isacharcolon}\ split{\isacharunderscore}leaf{\isacharprime}{\isacharprime}{\isacharparenright}\ {\isacharbar}\ {\isacharparenleft}k{\isacharcomma}v{\isacharparenright}{\isacharhash}{\isacharunderscore}\ {\isasymRightarrow}\ k{\isacharparenright}\ in\isanewline
\ \ {\isacharparenleft}l{\isacharcomma}k{\isacharcomma}r{\isacharparenright}\isanewline
{\isacharparenright}{\isachardoublequoteclose}\isanewline
\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ step{\isacharunderscore}bottom\ {\isacharcolon}{\isacharcolon}\ {\isachardoublequoteopen}{\isacharprime}k\ ps{\isadigit{1}}\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharcomma}{\isacharprime}t{\isacharparenright}\ store{\isacharunderscore}ops\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ d\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ u{\isacharcomma}{\isacharprime}t{\isacharparenright}\ MM{\isachardoublequoteclose}\ \isakeyword{where}\isanewline
{\isachardoublequoteopen}step{\isacharunderscore}bottom\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ d\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ let\ {\isacharparenleft}cs{\isacharcomma}k{\isacharunderscore}ord{\isacharparenright}\ {\isacharequal}\ {\isacharparenleft}ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}constants{\isacharcomma}ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}cmp{\isacharparenright}\ in\isanewline
\ \ {\isacharparenleft}{\isacharasterisk}\ let\ store{\isacharunderscore}ops\ {\isacharequal}\ ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}store{\isacharunderscore}ops\ in\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ let\ {\isacharparenleft}fs{\isacharcomma}{\isacharparenleft}v{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharparenright}\ {\isacharequal}\ d\ in\isanewline
\ \ case\ dest{\isacharunderscore}f{\isacharunderscore}finished\ fs\ of\ \isanewline
\ \ None\ {\isasymRightarrow}\ impossible{\isadigit{1}}\ {\isacharparenleft}STR\ {\isacharprime}{\isacharprime}insert{\isacharcomma}\ step{\isacharunderscore}bottom{\isacharprime}{\isacharprime}{\isacharparenright}\isanewline
\ \ {\isacharbar}\ Some{\isacharparenleft}r{\isadigit{0}}{\isacharcomma}k{\isacharcomma}r{\isacharcomma}kvs{\isacharcomma}stk{\isacharparenright}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}free{\isacharparenright}\ {\isacharparenleft}r{\isadigit{0}}{\isacharhash}{\isacharparenleft}r{\isacharunderscore}stk{\isacharunderscore}to{\isacharunderscore}rs\ stk{\isacharparenright}{\isacharparenright}\ {\isacharbar}{\isachargreater}\ bind\ \isanewline
\ \ \ \ {\isacharparenleft}{\isacharpercent}\ {\isacharunderscore}{\isachardot}\isanewline
\ \ \ \ let\ {\isacharparenleft}l{\isacharcomma}u{\isacharparenright}\ {\isacharequal}\ rstack{\isacharunderscore}get{\isacharunderscore}bounds\ stk\ in\isanewline
\ \ \ \ let\ {\isacharparenleft}kvs{\isacharprime}{\isacharcomma}kvs{\isadigit{0}}{\isacharprime}{\isacharparenright}\ {\isacharequal}\ kvs{\isacharunderscore}insert{\isacharunderscore}{\isadigit{2}}\ cs\ k{\isacharunderscore}ord\ u\ {\isacharparenleft}k{\isacharcomma}v{\isacharparenright}\ kvs{\isadigit{0}}\ kvs\ in\isanewline
\ \ \ \ let\ fo\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ case\ {\isacharparenleft}length\ kvs{\isacharprime}\ {\isasymle}\ cs{\isacharbar}{\isachargreater}max{\isacharunderscore}leaf{\isacharunderscore}size{\isacharparenright}\ of\isanewline
\ \ \ \ \ \ True\ {\isasymRightarrow}\ {\isacharparenleft}Disk{\isacharunderscore}leaf\ kvs{\isacharprime}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ r{\isacharprime}{\isachardot}\ IM{\isadigit{1}}{\isacharparenleft}r{\isacharprime}{\isacharcomma}kvs{\isadigit{0}}{\isacharprime}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ \ \ {\isacharbar}\ False\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ \ \ let\ {\isacharparenleft}kvs{\isadigit{1}}{\isacharcomma}k{\isacharprime}{\isacharcomma}kvs{\isadigit{2}}{\isacharparenright}\ {\isacharequal}\ split{\isacharunderscore}leaf\ cs\ kvs{\isacharprime}\ in\isanewline
\ \ \ \ \ \ \ \ Disk{\isacharunderscore}leaf\ kvs{\isadigit{1}}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ bind\isanewline
\ \ \ \ \ \ \ \ {\isacharparenleft}{\isacharpercent}\ r{\isadigit{1}}{\isachardot}\ Disk{\isacharunderscore}leaf\ kvs{\isadigit{2}}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ r{\isadigit{2}}{\isachardot}\ IM{\isadigit{2}}{\isacharparenleft}{\isacharparenleft}r{\isadigit{1}}{\isacharcomma}k{\isacharprime}{\isacharcomma}r{\isadigit{2}}{\isacharparenright}{\isacharcomma}kvs{\isadigit{0}}{\isacharprime}{\isacharparenright}{\isacharparenright}{\isacharparenright}{\isacharparenright}\ {\isacharparenright}\isanewline
\ \ \ \ in\isanewline
\ \ \ \ fo\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ fo{\isachardot}\ {\isacharparenleft}fo{\isacharcomma}stk{\isacharparenright}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
{\isacharparenright}{\isachardoublequoteclose}\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ step{\isacharunderscore}up\ {\isacharcolon}{\isacharcolon}\ {\isachardoublequoteopen}{\isacharprime}k\ ps{\isadigit{1}}\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharcomma}{\isacharprime}t{\isacharparenright}\ store{\isacharunderscore}ops\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ u\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ u{\isacharcomma}{\isacharprime}t{\isacharparenright}\ MM{\isachardoublequoteclose}\ \isakeyword{where}\isanewline
{\isachardoublequoteopen}step{\isacharunderscore}up\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ u\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ let\ {\isacharparenleft}cs{\isacharcomma}k{\isacharunderscore}ord{\isacharparenright}\ {\isacharequal}\ {\isacharparenleft}ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}constants{\isacharcomma}ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}cmp{\isacharparenright}\ in\isanewline
\ \ {\isacharparenleft}{\isacharasterisk}\ let\ store{\isacharunderscore}ops\ {\isacharequal}\ ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}store{\isacharunderscore}ops\ in\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ let\ {\isacharparenleft}fo{\isacharcomma}stk{\isacharparenright}\ {\isacharequal}\ u\ in\isanewline
\ \ case\ stk\ of\ \isanewline
\ \ {\isacharbrackleft}{\isacharbrackright}\ {\isasymRightarrow}\ impossible{\isadigit{1}}\ {\isacharparenleft}STR\ {\isacharprime}{\isacharprime}insert{\isacharcomma}\ step{\isacharunderscore}up{\isacharprime}{\isacharprime}{\isacharparenright}\ {\isacharparenleft}{\isacharasterisk}\ FIXME\ what\ about\ trace{\isacharquery}\ can{\isacharprime}t\ have\ arb\ here{\isacharsemicolon}\ or\ just\ stutter\ on\ I{\isacharunderscore}finished\ in\ step{\isacharquery}\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ {\isacharbar}\ x{\isacharhash}stk{\isacharprime}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ case\ fo\ of\isanewline
\ \ \ \ IM{\isadigit{1}}\ {\isacharparenleft}r{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ let\ {\isacharparenleft}ks{\isacharcomma}rs{\isacharparenright}\ {\isacharequal}\ unsplit{\isacharunderscore}node\ {\isacharparenleft}x{\isasymlparr}r{\isacharunderscore}t{\isacharcolon}{\isacharequal}r{\isasymrparr}{\isacharparenright}\ in\isanewline
\ \ \ \ \ \ mk{\isacharunderscore}Disk{\isacharunderscore}node{\isacharparenleft}ks{\isacharcomma}rs{\isacharparenright}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ r{\isachardot}\ {\isacharparenleft}IM{\isadigit{1}}\ {\isacharparenleft}r{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharcomma}stk{\isacharprime}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ {\isacharbar}\ IM{\isadigit{2}}\ {\isacharparenleft}{\isacharparenleft}r{\isadigit{1}}{\isacharcomma}k{\isacharcomma}r{\isadigit{2}}{\isacharparenright}{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ let\ {\isacharparenleft}ks{\isadigit{2}}{\isacharcomma}rs{\isadigit{2}}{\isacharparenright}\ {\isacharequal}\ {\isacharparenleft}x{\isacharbar}{\isachargreater}r{\isacharunderscore}ks{\isadigit{2}}{\isacharcomma}x{\isacharbar}{\isachargreater}r{\isacharunderscore}ts{\isadigit{2}}{\isacharparenright}\ in\isanewline
\ \ \ \ \ \ let\ {\isacharparenleft}ks{\isacharprime}{\isacharcomma}rs{\isacharprime}{\isacharparenright}\ {\isacharequal}\ unsplit{\isacharunderscore}node\ {\isacharparenleft}x{\isasymlparr}r{\isacharunderscore}ks{\isadigit{2}}{\isacharcolon}{\isacharequal}k{\isacharhash}ks{\isadigit{2}}{\isacharcomma}\ r{\isacharunderscore}ts{\isadigit{2}}{\isacharcolon}{\isacharequal}{\isacharbrackleft}r{\isadigit{1}}{\isacharcomma}r{\isadigit{2}}{\isacharbrackright}{\isacharat}rs{\isadigit{2}}{\isasymrparr}{\isacharparenright}\ in\isanewline
\ \ \ \ \ \ case\ {\isacharparenleft}List{\isachardot}length\ ks{\isacharprime}\ {\isasymle}\ cs{\isacharbar}{\isachargreater}max{\isacharunderscore}node{\isacharunderscore}keys{\isacharparenright}\ of\isanewline
\ \ \ \ \ \ True\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ \ \ mk{\isacharunderscore}Disk{\isacharunderscore}node{\isacharparenleft}ks{\isacharprime}{\isacharcomma}rs{\isacharprime}{\isacharparenright}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ r{\isachardot}\ {\isacharparenleft}IM{\isadigit{1}}\ {\isacharparenleft}r{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharcomma}stk{\isacharprime}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ \ \ {\isacharbar}\ False\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ \ \ let\ {\isacharparenleft}ks{\isacharunderscore}rs{\isadigit{1}}{\isacharcomma}k{\isacharcomma}ks{\isacharunderscore}rs{\isadigit{2}}{\isacharparenright}\ {\isacharequal}\ split{\isacharunderscore}node\ cs\ {\isacharparenleft}ks{\isacharprime}{\isacharcomma}rs{\isacharprime}{\isacharparenright}\ in\ \ {\isacharparenleft}{\isacharasterisk}\ FIXME\ move\ split{\isacharunderscore}node\ et\ al\ to\ this\ file\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ \ \ \ \ \ \ mk{\isacharunderscore}Disk{\isacharunderscore}node{\isacharparenleft}ks{\isacharunderscore}rs{\isadigit{1}}{\isacharparenright}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ bind\isanewline
\ \ \ \ \ \ \ \ {\isacharparenleft}{\isacharpercent}\ r{\isadigit{1}}{\isachardot}\ mk{\isacharunderscore}Disk{\isacharunderscore}node\ {\isacharparenleft}ks{\isacharunderscore}rs{\isadigit{2}}{\isacharparenright}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ fmap\ \isanewline
\ \ \ \ \ \ \ \ {\isacharparenleft}{\isacharpercent}\ r{\isadigit{2}}{\isachardot}\ {\isacharparenleft}IM{\isadigit{2}}{\isacharparenleft}{\isacharparenleft}r{\isadigit{1}}{\isacharcomma}k{\isacharcomma}r{\isadigit{2}}{\isacharparenright}{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharcomma}stk{\isacharprime}{\isacharparenright}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ {\isacharparenright}\isanewline
\ \ {\isacharparenright}\isanewline
{\isacharparenright}{\isachardoublequoteclose}\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ insert{\isacharunderscore}step\ {\isacharcolon}{\isacharcolon}\ {\isachardoublequoteopen}{\isacharprime}k\ ps{\isadigit{1}}\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharcomma}{\isacharprime}t{\isacharparenright}\ store{\isacharunderscore}ops\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ imst\ {\isasymRightarrow}\ {\isacharparenleft}{\isacharparenleft}{\isacharprime}k{\isacharcomma}{\isacharprime}v{\isacharcomma}{\isacharprime}r{\isacharparenright}\ imst{\isacharcomma}\ {\isacharprime}t{\isacharparenright}\ MM{\isachardoublequoteclose}\ \isakeyword{where}\isanewline
{\isachardoublequoteopen}insert{\isacharunderscore}step\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ s\ {\isacharequal}\ {\isacharparenleft}\isanewline
\ \ let\ {\isacharparenleft}cs{\isacharcomma}k{\isacharunderscore}ord{\isacharparenright}\ {\isacharequal}\ {\isacharparenleft}ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}constants{\isacharcomma}ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}cmp{\isacharparenright}\ in\isanewline
\ \ {\isacharparenleft}{\isacharasterisk}\ let\ store{\isacharunderscore}ops\ {\isacharequal}\ ps{\isadigit{1}}{\isacharbar}{\isachargreater}dot{\isacharunderscore}store{\isacharunderscore}ops\ in\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ case\ s\ of\ \isanewline
\ \ IM{\isacharunderscore}down\ d\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ let\ {\isacharparenleft}fs{\isacharcomma}{\isacharparenleft}v{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharparenright}\ {\isacharequal}\ d\ in\isanewline
\ \ \ \ case\ {\isacharparenleft}dest{\isacharunderscore}f{\isacharunderscore}finished\ fs{\isacharparenright}\ of\ \isanewline
\ \ \ \ None\ {\isasymRightarrow}\ {\isacharparenleft}step{\isacharunderscore}down\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ d\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ d{\isachardot}\ IM{\isacharunderscore}down\ d{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ {\isacharbar}\ Some\ {\isacharunderscore}\ {\isasymRightarrow}\ step{\isacharunderscore}bottom\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ d\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ u{\isachardot}\ IM{\isacharunderscore}up\ u{\isacharparenright}{\isacharparenright}\isanewline
\ \ {\isacharbar}\ IM{\isacharunderscore}up\ u\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ let\ {\isacharparenleft}fo{\isacharcomma}stk{\isacharparenright}\ {\isacharequal}\ u\ in\isanewline
\ \ \ \ case\ stk\ of\isanewline
\ \ \ \ {\isacharbrackleft}{\isacharbrackright}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ case\ fo\ of\ \isanewline
\ \ \ \ \ \ IM{\isadigit{1}}\ {\isacharparenleft}r{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}\ {\isasymRightarrow}\ return\ {\isacharparenleft}IM{\isacharunderscore}finished\ {\isacharparenleft}r{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ \ \ {\isacharbar}\ IM{\isadigit{2}}{\isacharparenleft}{\isacharparenleft}r{\isadigit{1}}{\isacharcomma}k{\isacharcomma}r{\isadigit{2}}{\isacharparenright}{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}\ {\isasymRightarrow}\ {\isacharparenleft}\isanewline
\ \ \ \ \ \ \ \ {\isacharparenleft}{\isacharasterisk}\ create\ a\ new\ frame\ {\isacharasterisk}{\isacharparenright}\isanewline
\ \ \ \ \ \ \ \ {\isacharparenleft}mk{\isacharunderscore}Disk{\isacharunderscore}node{\isacharparenleft}{\isacharbrackleft}k{\isacharbrackright}{\isacharcomma}{\isacharbrackleft}r{\isadigit{1}}{\isacharcomma}r{\isadigit{2}}{\isacharbrackright}{\isacharparenright}\ {\isacharbar}{\isachargreater}\ {\isacharparenleft}store{\isacharunderscore}ops{\isacharbar}{\isachargreater}store{\isacharunderscore}alloc{\isacharparenright}\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ r{\isachardot}\ IM{\isacharunderscore}finished\ {\isacharparenleft}r{\isacharcomma}kvs{\isadigit{0}}{\isacharparenright}{\isacharparenright}{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ \ \ {\isacharbar}\ {\isacharunderscore}\ {\isasymRightarrow}\ {\isacharparenleft}step{\isacharunderscore}up\ ps{\isadigit{1}}\ store{\isacharunderscore}ops\ u\ {\isacharbar}{\isachargreater}\ fmap\ {\isacharparenleft}{\isacharpercent}\ u{\isachardot}\ IM{\isacharunderscore}up\ u{\isacharparenright}{\isacharparenright}{\isacharparenright}\isanewline
\ \ {\isacharbar}\ IM{\isacharunderscore}finished\ f\ {\isasymRightarrow}\ {\isacharparenleft}return\ s{\isacharparenright}\ \ {\isacharparenleft}{\isacharasterisk}\ stutter\ {\isacharasterisk}{\isacharparenright}\isanewline
{\isacharparenright}{\isachardoublequoteclose}\isanewline
%
\isadelimtheory
\isanewline
%
\endisadelimtheory
%
\isatagtheory
\isacommand{end}\isamarkupfalse%
%
\endisatagtheory
{\isafoldtheory}%
%
\isadelimtheory
%
\endisadelimtheory
\end{isabellebody}%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "root"
%%% End:
